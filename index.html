<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>New Year's Grand Prix</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="scene">

    <div class="bg-wrapper">

        <!-- –§–æ–Ω—ã -->
        <div class="stars-bg"></div>
        <div class="header-bg"></div>

        <div class="ranks-wrapper">
            <div class="team-rank gold">01</div>
            <div class="team-rank silver">02</div>
            <div class="team-rank bronze">03</div>
            <div class="team-rank">04</div>
            <div class="team-rank">05</div>
            <div class="team-rank">06</div>
            <div class="team-rank">07</div>
            <div class="team-rank">08</div>
            <div class="team-rank">09</div>
            <div class="team-rank">10</div>
            <div class="team-rank">11</div>
        </div>

        <!-- –¢–∞–±–ª–æ -->
        <div class="board">

            <!-- WILLIAMS -->
            <div class="team-row">
                    <div class="team-card team-williams">
                        <div class="team-logo"></div>
                        <div class="team-name">WILLIAMS</div>
                        <div class="team-points">0</div>
                    </div>
                </div>

            <!-- MERCEDES -->
            <div class="team-row team-mercedes">
                <div class="team-card team-mercedes">
                    <div class="team-logo"></div>
                    <div class="team-name">MERCEDES</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- MCLAREN -->
            <div class="team-row team-mclaren">
                <div class="team-card team-mclaren">
                    <div class="team-logo"></div>
                    <div class="team-name">MCLAREN</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- FERRARI -->
            <div class="team-row team-ferrari">
                <div class="team-card team-ferrari">
                    <div class="team-logo"></div>
                    <div class="team-name">FERRARI</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- SITRAK -->
            <div class="team-row team-sitrak">
                <div class="team-card team-sitrak">
                    <div class="team-logo"></div>
                    <div class="team-name">SITRAK</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- RED BULL -->
            <div class="team-row team-redbull">
                <div class="team-card team-redbull">
                    <div class="team-logo"></div>
                    <div class="team-name">RED BULL</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- HOWO -->
            <div class="team-row team-howo">
                <div class="team-card team-howo">
                    <div class="team-logo"></div>
                    <div class="team-name">HOWO</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- ASTON MARTIN -->
            <div class="team-row team-astonmartin">
                <div class="team-card team-astonmartin">
                    <div class="team-logo"></div>
                    <div class="team-name">ASTON MARTIN</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- LADA -->
            <div class="team-row team-lada">
                <div class="team-card team-lada">
                    <div class="team-logo"></div>
                    <div class="team-name">LADA</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- AURUS -->
            <div class="team-row team-aurus">
                <div class="team-card team-aurus">
                    <div class="team-logo"></div>
                    <div class="team-name">AURUS</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- –ë–ê–ó -->
            <div class="team-row team-baz">
                <div class="team-card team-baz">
                    <div class="team-logo"></div>
                    <div class="team-name">–ë–ê–ó</div>
                    <div class="team-points">87</div>
                </div>

            </div>

        </div>

    </div>

</div>

<!-- –î–æ–±–∞–≤—å –≤ CSS (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç): -->
<style>
.team-row {
  transition: margin-top 0.5s cubic-bezier(0.2, 0, 0, 1);
  margin-top: 0 !important;
}
.team-row.animating {
  transition: margin-top 0.5s cubic-bezier(0.2, 0, 0, 1) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let isAnimating = false;
    let fakeRaceRunning = false;
    const roundQueue = [];

    const board = document.querySelector('.board');
    if (!board) {
        console.error('Board not found');
        return;
    }

    // ==============================
    // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–π
    // ==============================
    function getRows() {
        return Array.from(board.querySelectorAll('.team-row'));
    }

    function capturePositions(rows) {
        const boardRect = board.getBoundingClientRect();
        rows.forEach(row => {
            const rect = row.getBoundingClientRect();
            row.dataset.realTop = rect.top - boardRect.top;
        });
    }

    function freezePositions(rows) {
        board.style.height = board.offsetHeight + 'px';
        rows.forEach(row => {
            row.style.position = 'absolute';
            row.style.top = row.dataset.realTop + 'px';
            row.style.left = '0';
            row.style.width = '100%';
            row.style.margin = '0';
            row.style.transition = 'none';
        });
    }

    function unfreezePositions(rows) {
        rows.forEach(row => {
            row.style.position = '';
            row.style.top = '';
            row.style.left = '';
            row.style.width = '';
            row.style.transition = '';
            row.style.zIndex = '';
        });
        board.style.height = '';
    }

    // ==============================
    // –û–¥–∏–Ω –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –æ–±–≥–æ–Ω
    // ==============================
    function smoothOvertake(lowerIndex, upperIndex, callback) {
        if (isAnimating) return;
        isAnimating = true;

        const rows = getRows();
        const lower = rows[lowerIndex];
        const upper = rows[upperIndex];

        capturePositions(rows);
        freezePositions(rows);

        const lowerTop = parseFloat(lower.dataset.realTop);
        const upperTop = parseFloat(upper.dataset.realTop);

        lower.style.zIndex = 3;
        upper.style.zIndex = 2;

        lower.offsetHeight; // reflow

        requestAnimationFrame(() => {
            lower.style.transition = 'top 700ms cubic-bezier(.4,0,.2,1)';
            upper.style.transition = 'top 700ms cubic-bezier(.4,0,.2,1)';
            lower.style.top = upperTop + 'px';
            upper.style.top = lowerTop + 'px';
        });

        setTimeout(() => {
            board.insertBefore(lower, upper);
            unfreezePositions(getRows());
            isAnimating = false;
            callback && callback();
        }, 750);
    }

    // ==============================
    // –§–µ–π–∫–æ–≤—ã–µ –æ–±–≥–æ–Ω—ã (—Å–µ—Ä–∏—è)
    // ==============================
    function fakeRace(count, done) {
        let step = 0;

        function nextFake() {
            if (step >= count) {
                fakeRaceRunning = false;
                isAnimating = false;
                done && done();

                if (roundQueue.length) {
                    const nextRound = roundQueue.shift();
                    nextRound();
                }
                return;
            }

            const rows = getRows();
            const i = 1 + Math.floor(Math.random() * (rows.length - 1));
            smoothOvertake(i, i - 1, () => {
                step++;
                setTimeout(nextFake, 300);
            });
        }

        fakeRaceRunning = true;
        nextFake();
    }

    // ==============================
    // –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –ø–æ –æ—á–∫–∞–º
    // ==============================
    function leaderboardRace(sortedTeamIds) {
        let targetPos = 0;

        function processNextTeam() {
            if (targetPos >= sortedTeamIds.length) return;

            const rows = getRows();
            const teamId = sortedTeamIds[targetPos];
            const currentIndex = rows.findIndex(r => +r.dataset.teamId === teamId);

            if (currentIndex === targetPos) {
                targetPos++;
                processNextTeam();
                return;
            }

            smoothOvertake(currentIndex, currentIndex - 1, () => {
                setTimeout(processNextTeam, 250);
            });
        }

        processNextTeam();
    }

    // ==============================
    // ‚úÖ –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ï –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ó–∞–ø—É—Å–∫ –æ–¥–Ω–æ–≥–æ —Ä–∞—É–Ω–¥–∞
    // ==============================
    function triggerRoundInternal(teamsData) {
        const sortedIds = [...teamsData]
            .sort((a, b) => b.score - a.score)
            .map(t => t.id);

        const run = () => {
            fakeRace(3, () => {
                leaderboardRace(sortedIds);
            });

            // üü¢ –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ –∞–Ω–∏–º–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ (–Ω–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å!)
            fetch("/api/round-started", { method: "POST" })
                .catch(err => console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ /round:", err));
        };

        if (fakeRaceRunning) {
            roundQueue.push(run); // —Å—Ç–∞–≤–∏–º –≤ –æ—á–µ—Ä–µ–¥—å ‚Äî –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥!
        } else {
            run(); // –∑–∞–ø—É—Å–∫–∞–µ–º –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
        }
    }

    // ==============================
    // Poll –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—á–∫–æ–≤
    // ==============================
    async function poll() {
        try {
            const res = await fetch("/api/scores");
            const data = await res.json();

            const rows = getRows();
            data.teams?.forEach(team => {
                const row = rows.find(r => +r.dataset.teamId === team.id);
                const pts = row?.querySelector(".team-points");
                if (pts) pts.textContent = team.score;
            });

            if (data.trigger_round) {
                triggerRoundInternal(data.teams);
                // üî¥ –ù–ï –¥–µ–ª–∞–µ–º POST –∑–¥–µ—Å—å ‚Äî –æ–Ω —É–∂–µ –≤–Ω—É—Ç—Ä–∏ triggerRoundInternal –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
            }

        } catch (e) {
            console.warn("Poll error:", e);
        }
    }

    // ==============================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    // ==============================
    const initialRows = getRows();
    initialRows.forEach((r, i) => r.dataset.teamId = i + 1);

    poll();
    setInterval(poll, 1000);

    // ==============================
    // –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è dev-–∫–Ω–æ–ø–∫–∏)
    // ==============================
    window.triggerRound = (teamsData) => {
        const runRound = () => {
            const rows = getRows();
            const sortedIds = [...teamsData]
                .sort((a, b) => b.score - a.score)
                .map(t => t.id);

            fakeRace(3, () => {
                leaderboardRace(sortedIds);
            });
        };

        if (fakeRaceRunning || isAnimating) {
            roundQueue.push(() => runRound());
        } else {
            runRound();
        }
    };
});
</script>

<script src="js/index.js"></script>

</body>
</html>
