<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>New Year's Grand Prix</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="scene">

    <div class="bg-wrapper">

        <!-- –§–æ–Ω—ã -->
        <div class="stars-bg"></div>
        <div class="header-bg"></div>

        <div class="ranks-wrapper">
            <div class="team-rank gold">01</div>
            <div class="team-rank silver">02</div>
            <div class="team-rank bronze">03</div>
            <div class="team-rank">04</div>
            <div class="team-rank">05</div>
            <div class="team-rank">06</div>
            <div class="team-rank">07</div>
            <div class="team-rank">08</div>
            <div class="team-rank">09</div>
            <div class="team-rank">10</div>
            <div class="team-rank">11</div>
        </div>

        <!-- –¢–∞–±–ª–æ -->
        <div class="board">

            <!-- WILLIAMS -->
            <div class="team-row">
                    <div class="team-card team-williams">
                        <div class="team-logo"></div>
                        <div class="team-name">WILLIAMS</div>
                        <div class="team-points">0</div>
                    </div>
                </div>

            <!-- MERCEDES -->
            <div class="team-row team-mercedes">
                <div class="team-card team-mercedes">
                    <div class="team-logo"></div>
                    <div class="team-name">MERCEDES</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- MCLAREN -->
            <div class="team-row team-mclaren">
                <div class="team-card team-mclaren">
                    <div class="team-logo"></div>
                    <div class="team-name">MCLAREN</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- FERRARI -->
            <div class="team-row team-ferrari">
                <div class="team-card team-ferrari">
                    <div class="team-logo"></div>
                    <div class="team-name">FERRARI</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- SITRAK -->
            <div class="team-row team-sitrak">
                <div class="team-card team-sitrak">
                    <div class="team-logo"></div>
                    <div class="team-name">SITRAK</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- RED BULL -->
            <div class="team-row team-redbull">
                <div class="team-card team-redbull">
                    <div class="team-logo"></div>
                    <div class="team-name">RED BULL</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- HOWO -->
            <div class="team-row team-howo">
                <div class="team-card team-howo">
                    <div class="team-logo"></div>
                    <div class="team-name">HOWO</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- ASTON MARTIN -->
            <div class="team-row team-astonmartin">
                <div class="team-card team-astonmartin">
                    <div class="team-logo"></div>
                    <div class="team-name">ASTON MARTIN</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- LADA -->
            <div class="team-row team-lada">
                <div class="team-card team-lada">
                    <div class="team-logo"></div>
                    <div class="team-name">LADA</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- AURUS -->
            <div class="team-row team-aurus">
                <div class="team-card team-aurus">
                    <div class="team-logo"></div>
                    <div class="team-name">AURUS</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- –ë–ê–ó -->
            <div class="team-row team-baz">
                <div class="team-card team-baz">
                    <div class="team-logo"></div>
                    <div class="team-name">–ë–ê–ó</div>
                    <div class="team-points">87</div>
                </div>

            </div>

        </div>

    </div>

</div>

<script>
// üîß –ê–Ω–∏–º–∞—Ü–∏—è ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
{
    let isAnimating = false;
    let lastTrigger = false;

    // –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –æ–Ω–∏ —É–∂–µ –≤ DOM
    const rows = Array.from(document.querySelectorAll('.team-row'));
    const ranks = Array.from(document.querySelectorAll('.ranks-wrapper .team-rank'));

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    rows.forEach((row, i) => {
        row.style.order = i;
    });

    function moveRowTo(row, targetIndex) {
        const currentOrder = parseInt(row.style.order);
        if (currentOrder === targetIndex) return;

        const currentTop = row.offsetTop;
        row.style.order = targetIndex;
        void row.offsetParent; // reflow
        const newTop = row.offsetTop;

        row.style.transition = 'none';
        row.style.transform = `translateY(${currentTop - newTop}px)`;
        requestAnimationFrame(() => {
            row.style.transition = 'transform 0.5s cubic-bezier(0.2,0,0,1)';
            row.style.transform = 'translateY(0)';
        });
    }

    function animateToRealRanking() {
        const sorted = [...rows].sort((a, b) => {
            const sA = parseInt(a.querySelector('.team-points')?.textContent || '0');
            const sB = parseInt(b.querySelector('.team-points')?.textContent || '0');
            return sB - sA;
        });
        sorted.forEach((row, i) => {
            moveRowTo(row, i);
            if (ranks[i]) ranks[i].textContent = String(i + 1).padStart(2, '0');
        });
    }

    function simulateRace() {
        if (isAnimating) return;
        isAnimating = true;

        let step = 0;
        const doStep = () => {
            if (step >= 5) {
                setTimeout(() => {
                    animateToRealRanking();
                    setTimeout(() => isAnimating = false, 600);
                }, 300);
                return;
            }

            const shuffled = [...rows].sort(() => Math.random() - 0.5);
            shuffled.forEach((row, i) => moveRowTo(row, i));
            step++;
            setTimeout(doStep, 400);
        };

        doStep();
    }

    async function poll() {
        try {
            const res = await fetch('/api/scores');
            const data = await res.json();

            data.teams.forEach(team => {
                const row = rows[team.id - 1]; // 1 ‚Üí index 0, 2 ‚Üí index 1...
                const pts = row?.querySelector('.team-points');
                if (pts) pts.textContent = team.score;
            });

            if (data.trigger_round && !lastTrigger) {
                lastTrigger = true;
                simulateRace();
                setTimeout(() => lastTrigger = false, 6000);
            }
        } catch (e) {
            console.warn("Poll error:", e);
        }
    }

    setInterval(poll, 1000);
    poll();

    // –î–ª—è —Ç–µ—Å—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏
    window.round = simulateRace;
}
</script>

</body>
</html>
