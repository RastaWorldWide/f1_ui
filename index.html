<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>New Year's Grand Prix</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="scene">

    <div class="bg-wrapper">

        <!-- Фоны -->
        <div class="stars-bg"></div>
        <div class="header-bg"></div>

        <div class="ranks-wrapper">
            <div class="team-rank gold">01</div>
            <div class="team-rank silver">02</div>
            <div class="team-rank bronze">03</div>
            <div class="team-rank">04</div>
            <div class="team-rank">05</div>
            <div class="team-rank">06</div>
            <div class="team-rank">07</div>
            <div class="team-rank">08</div>
            <div class="team-rank">09</div>
            <div class="team-rank">10</div>
            <div class="team-rank">11</div>
        </div>

        <!-- Табло -->
        <div class="board">

            <!-- WILLIAMS -->
            <div class="team-row">
                    <div class="team-card team-williams">
                        <div class="team-logo"></div>
                        <div class="team-name">WILLIAMS</div>
                        <div class="team-points">0</div>
                    </div>
                </div>

            <!-- MERCEDES -->
            <div class="team-row team-mercedes">
                <div class="team-card team-mercedes">
                    <div class="team-logo"></div>
                    <div class="team-name">MERCEDES</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- MCLAREN -->
            <div class="team-row team-mclaren">
                <div class="team-card team-mclaren">
                    <div class="team-logo"></div>
                    <div class="team-name">MCLAREN</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- FERRARI -->
            <div class="team-row team-ferrari">
                <div class="team-card team-ferrari">
                    <div class="team-logo"></div>
                    <div class="team-name">FERRARI</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- SITRAK -->
            <div class="team-row team-sitrak">
                <div class="team-card team-sitrak">
                    <div class="team-logo"></div>
                    <div class="team-name">SITRAK</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- RED BULL -->
            <div class="team-row team-redbull">
                <div class="team-card team-redbull">
                    <div class="team-logo"></div>
                    <div class="team-name">RED BULL</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- HOWO -->
            <div class="team-row team-howo">
                <div class="team-card team-howo">
                    <div class="team-logo"></div>
                    <div class="team-name">HOWO</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- ASTON MARTIN -->
            <div class="team-row team-astonmartin">
                <div class="team-card team-astonmartin">
                    <div class="team-logo"></div>
                    <div class="team-name">ASTON MARTIN</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- LADA -->
            <div class="team-row team-lada">
                <div class="team-card team-lada">
                    <div class="team-logo"></div>
                    <div class="team-name">LADA</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- AURUS -->
            <div class="team-row team-aurus">
                <div class="team-card team-aurus">
                    <div class="team-logo"></div>
                    <div class="team-name">AURUS</div>
                    <div class="team-points">87</div>
                </div>
            </div>

            <!-- БАЗ -->
            <div class="team-row team-baz">
                <div class="team-card team-baz">
                    <div class="team-logo"></div>
                    <div class="team-name">БАЗ</div>
                    <div class="team-points">87</div>
                </div>

            </div>

        </div>

    </div>

</div>

<!-- Добавь в CSS (если ещё нет): -->
<style>
.team-row {
  transition: margin-top 0.5s cubic-bezier(0.2, 0, 0, 1);
  margin-top: 0 !important;
}
.team-row.animating {
  transition: margin-top 0.5s cubic-bezier(0.2, 0, 0, 1) !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let isAnimating = false;
    let roundStarted = false;

    const board = document.querySelector('.board');
    let rows = Array.from(board.querySelectorAll('.team-row'));

    if (!board || rows.length < 2) {
        console.error('Board or rows not found');
        return;
    }

    // ==============================
    // Утилиты позиций
    // ==============================
    function capturePositions() {
        const boardRect = board.getBoundingClientRect();
        rows.forEach(row => {
            const rect = row.getBoundingClientRect();
            row.dataset.realTop = rect.top - boardRect.top;
        });
    }

    function freezePositions() {
        board.style.height = board.offsetHeight + 'px';
        rows.forEach(row => {
            row.style.position = 'absolute';
            row.style.top = row.dataset.realTop + 'px';
            row.style.left = '0';
            row.style.width = '100%';
            row.style.margin = '0';
            row.style.transition = 'none';
        });
    }

    function unfreezePositions() {
        rows.forEach(row => {
            row.style.position = '';
            row.style.top = '';
            row.style.left = '';
            row.style.width = '';
            row.style.transition = '';
            row.style.zIndex = '';
        });
        board.style.height = '';
    }

    // ==============================
    // Один аккуратный обгон
    // ==============================
    function smoothOvertake(lowerIndex, upperIndex, callback) {
        if (isAnimating) return;
        isAnimating = true;

        const lower = rows[lowerIndex];
        const upper = rows[upperIndex];

        capturePositions();
        freezePositions();

        const lowerTop = parseFloat(lower.dataset.realTop);
        const upperTop = parseFloat(upper.dataset.realTop);

        lower.style.zIndex = 3;
        upper.style.zIndex = 2;

        lower.offsetHeight;

        requestAnimationFrame(() => {
            lower.style.transition = 'top 700ms cubic-bezier(.4,0,.2,1)';
            upper.style.transition = 'top 700ms cubic-bezier(.4,0,.2,1)';
            lower.style.top = upperTop + 'px';
            upper.style.top = lowerTop + 'px';
        });

        setTimeout(() => {
            board.insertBefore(lower, upper);
            rows.splice(upperIndex, 0, rows.splice(lowerIndex, 1)[0]);
            unfreezePositions();
            isAnimating = false;
            callback && callback();
        }, 750);
    }

    // ==============================
    // 3 фейковых обгона ПО ОЧЕРЕДИ
    // ==============================
    function fakeRace(count, done) {
        let step = 0;

        function nextFake() {
            if (step >= count) {
                done && done();
                return;
            }

            const i = 1 + Math.floor(Math.random() * (rows.length - 1));
            smoothOvertake(i, i - 1, () => {
                step++;
                setTimeout(nextFake, 300); // пауза между фейками
            });
        }

        nextFake();
    }

    // ==============================
    // Реальный лидерборд
    // ==============================
    function leaderboardRace(sortedTeamIds) {
    let targetPos = 0;

    function processNextTeam() {
        if (targetPos >= sortedTeamIds.length) return;

        const teamId = sortedTeamIds[targetPos];
        let currentIndex = rows.findIndex(
            r => +r.dataset.teamId === teamId
        );

        // Если команда уже на нужной позиции — идём дальше
        if (currentIndex === targetPos) {
            targetPos++;
            processNextTeam();
            return;
        }

        // Двигаем ТОЛЬКО на 1 позицию вверх
        smoothOvertake(currentIndex, currentIndex - 1, () => {
            // после одного обгона проверяем снова эту же команду
            setTimeout(processNextTeam, 250);
        });
    }

    processNextTeam();
}


    // ==============================
    // Poll
    // ==============================
    async function poll() {
        try {
            const res = await fetch("/api/scores");
            const data = await res.json();

            data.teams?.forEach(team => {
                const row = rows.find(r => +r.dataset.teamId === team.id);
                const pts = row?.querySelector(".team-points");
                if (pts) pts.textContent = team.score;
            });

            if (data.trigger_round && !roundStarted) {
                roundStarted = true;

                const sortedIds = [...data.teams]
                    .sort((a, b) => b.score - a.score)
                    .map(t => t.id);

                fakeRace(3, () => {
                    leaderboardRace(sortedIds);
                });
            }

        } catch (e) {
            console.warn("Poll error:", e);
        }
    }

    // ==============================
    // Init
    // ==============================
    rows.forEach((r, i) => r.dataset.teamId = i + 1);

    poll();
    setInterval(poll, 1000);
});
</script>

<script src="js/index.js"></script>

</body>
</html>
